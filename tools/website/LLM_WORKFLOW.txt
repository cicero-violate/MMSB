# LLM Agent Workflow with Task Tracking

## Task Tracking Endpoints

**Create task:**
```
GET /create-task?task_id=TASK_001&description=Fix%20cache%20headers&_t=T1
```

**Track context queries:**
```
GET /add-context?task_id=TASK_001&query_url=/mmsb/file.js?_t=T2
```

**Link instruction:**
```
GET /add-instruction?task_id=TASK_001&instruction_id=FIX_CACHE_001&action=created&_t=T3
```

**Complete task:**
```
GET /complete-task?task_id=TASK_001&status=completed&result=success&_t=T4
```

**List/Get tasks:**
```
GET /list-tasks?_t=T5
GET /task?task_id=TASK_001&_t=T6
```

## Complete Workflow: Build & Save

1. **Create task**
   ```
   GET /create-task?task_id=TASK_001&description=User%20request&_t=T1
   ```

2. **Gather context**
   ```
   GET /mmsb/?format=json&_t=T2
   GET /add-context?task_id=TASK_001&query_url=/mmsb/?format=json&_t=T3
   
   GET /mmsb/path/file.ext?_t=T4
   GET /add-context?task_id=TASK_001&query_url=/mmsb/path/file.ext&_t=T5
   ```

3. **Check existing instructions**
   ```
   GET /list-instructions?_t=T6
   ```

4. **Build patch preview**
   ```
   GET /build-patch?template=simple_replace&file=X&old_line=A&new_line=B&context_before=C&context_after=D&_t=T7
   ```

5. **Save instruction**
   ```
   GET /save-instruction?id=FIX_001&file=X&template=simple_replace&old_line=A&new_line=B&context_before=C&context_after=D&purpose=Fix%20X&risk=low&_t=T8
   GET /add-instruction?task_id=TASK_001&instruction_id=FIX_001&action=created&_t=T9
   ```

6. **Apply instruction**
   ```
   GET /apply-instruction?id=FIX_001&_t=T10
   GET /add-instruction?task_id=TASK_001&instruction_id=FIX_001&action=applied&_t=T11
   ```

7. **Complete task**
   ```
   GET /complete-task?task_id=TASK_001&status=completed&result=success&_t=T12
   ```

## Reuse Existing Instruction

1. **Create task**
   ```
   GET /create-task?task_id=TASK_002&description=Reuse%20FIX_001&_t=T1
   ```

2. **Check instructions**
   ```
   GET /list-instructions?_t=T2
   GET /instruction?id=FIX_001&_t=T3
   ```

3. **Verify file state**
   ```
   GET /mmsb/path/file?_t=T4
   GET /add-context?task_id=TASK_002&query_url=/mmsb/path/file&_t=T5
   ```

4. **Apply & complete**
   ```
   GET /apply-instruction?id=FIX_001&_t=T6
   GET /add-instruction?task_id=TASK_002&instruction_id=FIX_001&action=reused&_t=T7
   GET /complete-task?task_id=TASK_002&status=completed&result=success&_t=T8
   ```

## Directory Structure

```
tasks/
  TASK_001/
    task.json
  index.json

instructions/
  FIX_001/
    patch.diff
    target.json
    meta.json
  index.json
```

## Task JSON Format

```json
{
  "id": "TASK_001",
  "description": "Fix cache headers",
  "status": "completed",
  "created": "2025-12-19T00:10:00Z",
  "completed": "2025-12-19T00:15:00Z",
  "context_queries": [
    {"url": "/mmsb/file.js", "timestamp": "..."}
  ],
  "instructions": [
    {"id": "FIX_001", "action": "created", "timestamp": "..."},
    {"id": "FIX_001", "action": "applied", "timestamp": "..."}
  ],
  "result": "success"
}
```

## Templates

### simple_replace
```
?template=simple_replace&file=X&old_line=A&new_line=B&context_before=C&context_after=D
```

### add_cache_headers
```
?template=add_cache_headers&file=X&function=funcName&old_line=A&context_before=C&context_after=D
```

### Direct mode
```
?file=X&line_before=A&line_after=B&context_1=C1&context_2=C2&context_3=C3
```

## Benefits

- **Auditability**: Every action tracked
- **Replay**: Reconstruct entire session
- **Learning**: See which instructions work
- **Efficiency**: Reuse proven patterns
- **Pure GET**: No POST/PUT needed
